<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reporte de Costos y Utilidad</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 p-6">
    <div id="app" class="max-w-xl mx-auto bg-white p-8 rounded-2xl shadow-xl border border-gray-100">
        <h1 id="titulo" class="text-2xl font-bold text-gray-800 mb-6">Cargando datos de la orden...</h1>
        
        <div id="contenido" class="space-y-6">
            <div id="loader" class="animate-pulse flex space-y-4 flex-col">
                <div class="h-4 bg-gray-200 rounded w-3/4"></div>
                <div class="h-4 bg-gray-200 rounded w-1/2"></div>
            </div>
        </div>

        <button onclick="window.history.back()" class="mt-8 w-full bg-gray-800 text-white py-2 rounded-lg hover:bg-gray-700 transition">
            Volver al Historial
        </button>
    </div>

    <script>
        async function cargarReporte() {
            const params = new URLSearchParams(window.location.search);
            const id = params.get('id');
            const titulo = document.getElementById('titulo');
            const contenido = document.getElementById('contenido');

            if (!id) {
                titulo.textContent = "Error: No se encontró el ID de la orden";
                contenido.innerHTML = `<p class="text-red-500">Regresa al historial y vuelve a hacer clic en el botón azul.</p>`;
                return;
            }

            try {
                // LLAMADA A TU SERVIDOR EN NETLIFY
                const res = await fetch(`/.netlify/functions/server/invoices/${id}`);
                
                if (!res.ok) throw new Error("No se pudo obtener la información");
                
                const data = await res.json();
                
                const cop = new Intl.NumberFormat('es-CO', { 
                    style: 'currency', 
                    currency: 'COP', 
                    maximumFractionDigits: 0 
                });

                // Cálculos extraídos de tu base de datos
                const costoMat = data.costo_materiales_total || 0;
                const manoObra = data.mano_obra_total || 0;
                const totalFactura = data.totalFactura || data.total || 0;

                titulo.textContent = `Análisis de la Orden: ${data.numeroFactura || 'S/N'}`;
                
                contenido.innerHTML = `
                    <div class="p-4 bg-blue-50 rounded-lg border border-blue-100">
                        <p class="text-sm text-blue-600 font-semibold uppercase">Costo Base Materiales</p>
                        <p class="text-2xl font-bold text-blue-900">${cop.format(costoMat)}</p>
                    </div>

                    <div class="p-4 bg-green-50 rounded-lg border border-green-100">
                        <p class="text-sm text-green-600 font-semibold uppercase">Precio Sugerido (Costo x 3)</p>
                        <p class="text-2xl font-bold text-green-900">${cop.format(costoMat * 3)}</p>
                        <p class="text-xs text-green-700 mt-1">* Ideal para cubrir gastos fijos y utilidad.</p>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div class="p-4 bg-gray-50 rounded-lg border border-gray-200">
                            <p class="text-xs text-gray-500 font-semibold uppercase">Mano de Obra</p>
                            <p class="text-lg font-bold text-gray-800">${cop.format(manoObra)}</p>
                        </div>
                        <div class="p-4 bg-gray-50 rounded-lg border border-gray-200">
                            <p class="text-xs text-gray-500 font-semibold uppercase">Venta Real</p>
                            <p class="text-lg font-bold text-gray-800">${cop.format(totalFactura)}</p>
                        </div>
                    </div>

                    <div class="pt-4 border-t border-gray-100">
                        <p class="text-sm text-gray-600">Utilidad Bruta (Venta - Costo Mat.):</p>
                        <p class="text-xl font-bold ${totalFactura - costoMat > 0 ? 'text-green-600' : 'text-red-600'}">
                            ${cop.format(totalFactura - costoMat)}
                        </p>
                    </div>
                `;

            } catch (error) {
                console.error(error);
                titulo.textContent = "Error al cargar";
                contenido.innerHTML = `<p class="text-red-500">No se pudo conectar con el servidor. Verifica que la factura aún exista.</p>`;
            }
        }

        // Se ejecuta automáticamente al abrir la página
        window.onload = cargarReporte;
    </script>
</body>
</html>
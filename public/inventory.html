<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Historial de Ventas - Marqueter√≠a La Chica Morales</title>
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #f4f7f6; margin: 0; display: flex; }
        
        .sidebar { width: 250px; background-color: #2c3e50; color: white; height: 100vh; padding: 20px; position: fixed; }
        .sidebar h1 { font-size: 1.2rem; text-align: center; border-bottom: 1px solid #34495e; padding-bottom: 15px; }
        .sidebar a { display: block; color: white; text-decoration: none; padding: 15px; border-radius: 8px; margin: 10px 0; transition: 0.3s; }
        .sidebar a:hover { background-color: #34495e; transform: translateX(5px); }
        .sidebar a.active { background-color: #3498db; }

        .main-content { margin-left: 250px; flex-grow: 1; padding: 40px; }

        .history-container { 
            background: white; 
            padding: 30px; 
            border-radius: 15px; 
            box-shadow: 0 10px 25px rgba(0,0,0,0.1); 
        }

        .header-flex { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }

        .btn-excel { background-color: #1d8348; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: bold; }
        .btn-reporte { background-color: #5d5fef; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: bold; }

        .filter-bar { background: #f8fafc; padding: 20px; border-radius: 12px; display: flex; gap: 15px; align-items: center; margin-bottom: 20px; border: 1px solid #e2e8f0; }
        .filter-bar input { padding: 10px; border: 1px solid #cbd5e1; border-radius: 6px; }

        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { padding: 15px; text-align: left; border-bottom: 1px solid #eee; }
        th { background-color: #f8fafc; color: #64748b; text-transform: uppercase; font-size: 0.75rem; letter-spacing: 0.05em; }

        .price-tag { color: #2c3e50; font-weight: bold; }
        .date-tag { color: #64748b; font-size: 0.9em; }
        
        .empty-state { text-align: center; padding: 50px; color: #95a5a6; }
        .status-badge { padding: 4px 8px; border-radius: 12px; font-size: 0.75rem; background: #e8f5e9; color: #2e7d32; font-weight: 600; }

        @media print { .sidebar { display: none; } .main-content { margin: 0; padding: 20px; } }
    </style>
</head>
<body>

    <aside class="sidebar">
        <div class="logo"><h1>LA CHICA MORALES</h1></div>
        <nav class="menu">
            <a href="index.html" class="menu-item">üè† Inicio</a>
            <a href="dashboard.html" class="menu-item">üì¶ Inventario</a>
            <a href="quotes.html" class="menu-item">üí∞ Nueva Cotizaci√≥n</a>
            <a href="history.html" class="menu-item active">üìú Historial de √ìrdenes</a>
        </nav>
    </aside>

    <main class="main-content">
        <div class="history-container">
            <div class="header-flex">
                <h2 style="color: #1e3a8a;">Historial de √ìrdenes</h2>
                <div style="display: flex; gap: 10px;">
                    <button class="btn-excel">EXCEL</button>
                    <button class="btn-reporte">REPORTE HOY</button>
                </div>
            </div>

            <div class="filter-bar">
                <input type="text" placeholder="Buscar por OT o cliente..." style="flex-grow: 1;">
                <span>Desde:</span> <input type="date">
                <span>Hasta:</span> <input type="date">
                <button style="background: #3b82f6; color: white; border: none; padding: 10px 20px; border-radius: 6px;">Filtrar</button>
                <button style="background: #94a3b8; color: white; border: none; padding: 10px 20px; border-radius: 6px;">Limpiar</button>
            </div>
            
            <table id="ventasTable">
                <thead>
                    <tr>
                        <th>FECHA</th>
                        <th>N¬∞ ORDEN</th>
                        <th>CLIENTE</th>
                        <th>TOTAL</th>
                        <th>SALDO</th>
                        <th>ESTADO</th>
                        <th>ACCIONES</th>
                    </tr>
                </thead>
                <tbody id="historyBody"></tbody>
            </table>
            
            <div id="noData" class="empty-state" style="display: none;">
                <p id="errorMessage" style="font-weight: bold;"></p>
            </div>
        </div>
    </main>

    <script>
        async function cargarHistorial() {
            const tableBody = document.getElementById('historyBody');
            const noData = document.getElementById('noData');
            const errorMsg = document.getElementById('errorMessage');
            const ventasTable = document.getElementById('ventasTable');
            
            try {
                // AJUSTE: URL con par√°metro anti-cach√© para forzar descarga limpia
                const response = await fetch('/api/invoices?v=' + Date.now());
                
                if (!response.ok) {
                    throw new Error(`Servidor respondi√≥ con status: ${response.status}`);
                }

                const jsonResponse = await response.json();
                
                // AJUSTE DE FORMATO: Si es un arreglo directo lo usamos, si no, buscamos .data
                const ventas = Array.isArray(jsonResponse) ? jsonResponse : (jsonResponse.data || []);
                
                if (ventas.length === 0) {
                    noData.style.display = 'block';
                    ventasTable.style.display = 'none';
                    errorMsg.innerText = "No hay √≥rdenes registradas a√∫n.";
                    errorMsg.style.color = "#95a5a6";
                    return;
                }

                // Si hay datos, activamos la vista de tabla
                noData.style.display = 'none';
                ventasTable.style.display = 'table';
                tableBody.innerHTML = '';

                // Ordenar por fecha (m√°s reciente primero)
                ventas.sort((a, b) => new Date(b.fecha) - new Date(a.fecha));

                ventas.forEach(venta => {
                    const row = document.createElement('tr');
                    
                    // --- BLINDAJE DE DATOS SEG√öN TU JSON REAL ---
                    const fechaFmt = venta.fecha ? new Date(venta.fecha).toLocaleDateString() : '---';
                    
                    // Manejo de cliente (si viene como objeto o string)
                    const clienteRaw = venta.clienteNombre || (typeof venta.cliente === 'string' ? venta.cliente : venta.cliente?.nombre);
                    const cliente = (clienteRaw || 'Consumidor Final').toUpperCase();
                    
                    // Manejo de montos (usando los nombres de tu captura)
                    const total = Number(venta.totalFactura || venta.total || 0);
                    const saldo = Number(venta.saldoPendiente || venta.saldo || 0);
                    const ot = venta.numeroFactura || venta.ot || 'S/N';

                    row.innerHTML = `
                        <td class="date-tag">${fechaFmt}</td>
                        <td style="font-weight: bold;">${ot}</td>
                        <td>${cliente}</td>
                        <td class="price-tag">$ ${total.toLocaleString('es-CO')}</td>
                        <td style="color: ${saldo > 0 ? '#e74c3c' : '#27ae60'}; font-weight: bold;">$ ${saldo.toLocaleString('es-CO')}</td>
                        <td><span class="status-badge">${venta.estado || 'Completado'}</span></td>
                        <td>
                            <button style="border:none; background:none; color:#3b82f6; cursor:pointer;" title="Ver Detalle">
                                <i class="fas fa-eye"></i>
                            </button>
                        </td>
                    `;
                    tableBody.appendChild(row);
                });

            } catch (error) {
                console.error("‚ùå Error en fetch:", error);
                noData.style.display = 'block';
                ventasTable.style.display = 'none';
                errorMsg.innerText = "Error al conectar con el servidor. Revisa tu conexi√≥n.";
                errorMsg.style.color = "#ef4444";
            }
        }

        document.addEventListener('DOMContentLoaded', cargarHistorial);
    </script>
</body>
</html>